@using JobAgent.Models
@using JobAgent.Services

@inject AuthenticationService authService
@inject SecurityService securityService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider authenticationStateProvicer
@inject IHostEnvironmentAuthenticationStateProvider HostAuthentication

<BSButton Color="Color.Info" @onclick="@(() => LoginModal.Show())" href="#login">Praktikekonsulenter</BSButton>

<BSModal @ref="LoginModal" IsCentered="true" IgnoreEscape="true" IgnoreClickOnBackdrop="true">
    <BSModalHeader OnClick="@(() => LoginModal.Hide())">Praktikkonsulent Log Ind</BSModalHeader>
    <BSModalBody>
        @* Login Form *@
        <EditForm Model="model" OnValidSubmit="LogInUserAsync">

            @if (message != "" && message != null)
            {
                <BSAlert Color="Color.Dark">@message</BSAlert>
            }

            <DataAnnotationsValidator />
            <ValidationSummary />

            <BSFormGroup>
                <BSLabel For="inputEmail1">Email Adresse</BSLabel>
                <BSInput Id="inputEmail1" InputType="InputType.Email" PlaceHolder="Indtast email adresse.." @bind-Value="model.Email" />
            </BSFormGroup>
            <BSFormGroup>
                <BSLabel For="inputPassword">Adgangskode</BSLabel>
                <BSInput Id="inputPassword" InputType="InputType.Password" Placeholder="Indtast adgangskode.." @bind-Value="model.Password" />
            </BSFormGroup>
            <BSButton Color="Color.Info" ButtonType="ButtonType.Submit" Class="btn-block mr-2" IsDisabled="@isProcessing">Log ind</BSButton>

        </EditForm>
    </BSModalBody>
    <BSModalFooter>
        <BSButton Color="Color.Danger" @onclick="@(() => LoginModal.Hide())">Tilbage</BSButton>
    </BSModalFooter>
</BSModal>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthState { get; set; }

    BSModal LoginModal { get; set; }

    LogInModel model = new LogInModel();

    bool isProcessing = false;
    string message = string.Empty;

    ClaimsPrincipal principal = new ClaimsPrincipal();
    List<Claim> claims = new List<Claim>();

    public async Task LogInUserAsync()
    {
        isProcessing = true;
        message = "Processing request...";
        var result = await authService.LogInUserAsync(model);

        if (result.IsSuccess)
        {
            if (!(await AuthState).User.Identity.IsAuthenticated)
            {
                claims.Add(new Claim(ClaimTypes.Name, $"{result.UserInfo.FirstName} {result.UserInfo.LastName}"));
                claims.Add(new Claim(ClaimTypes.Email, result.UserInfo.Email));

                principal.AddIdentity(new ClaimsIdentity(claims));

                var identity = new ClaimsIdentity(
                    principal.Claims,
                    Microsoft.AspNetCore.Authentication.Cookies.CookieAuthenticationDefaults.AuthenticationScheme
                );

                principal = new ClaimsPrincipal(identity);

                HostAuthentication.SetAuthenticationState(Task.FromResult(new AuthenticationState(principal)));

                AuthState = authenticationStateProvicer.GetAuthenticationStateAsync();

                navigationManager.NavigateTo("/", true);
            }
        }
        else
        {
            message = result.Message;

        }
        isProcessing = false;
    }

    protected async override void OnParametersSet()
    {
        if (AuthState != null)
        {
            principal = (await AuthState).User;
        }
    }
}
