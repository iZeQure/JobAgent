@page "/login"

@using System.Security.Claims
@using JobAgent.Models
@using JobAgent.Data
@using JobAgent.Data.Interfaces

@*@inject AuthenticationStateProvider authenticationStateProvider*@
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager navigationManager
@inject IUserService userService
@* Login Form *@
<EditForm Model="userModel" OnValidSubmit="@ValidateUserAsync">

    @if (LoginMessage != "" && LoginMessage != null)
    {
        <BSAlert Color="Color.Danger">@LoginMessage</BSAlert>
    }

    <DataAnnotationsValidator />
    <ValidationSummary />

    <BSFormGroup>
        <BSLabel For="inputEmail1">Email Adresse</BSLabel>
        <BSInput Id="inputEmail1" InputType="InputType.Email" PlaceHolder="Indtast email adresse.." @bind-Value="userModel.Email" />
    </BSFormGroup>
    <BSFormGroup>
        <BSLabel For="inputPassword">Adgangskode</BSLabel>
        <BSInput Id="inputPassword" InputType="InputType.Password" Placeholder="Indtast adgangskode.." @bind-Value="userModel.Password" />
    </BSFormGroup>
    <BSButton Color="Color.Info" ButtonType="ButtonType.Submit" Class="btn-block mr-2" IsDisabled="@IsProcessing">Log ind</BSButton>

</EditForm>

@code {
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationState { get; set; }

    public string LoginMessage { get; set; }

    public bool IsProcessing { get; set; } = false;

    public LogInModel userModel = new LogInModel();

    private User user;
    private ClaimsPrincipal claimsPrincipal;

    protected async override Task OnInitializedAsync()
    {
        user = new User();

        claimsPrincipal = (await AuthenticationState).User;

        if (claimsPrincipal.Identity.IsAuthenticated)
        {
            await Task.FromResult(PageMetaModel.Instance.Title = $"Velkommen, {user.FirstName} {user.LastName}");
            navigationManager.NavigateTo("admin", true);
        }
    }

    private async Task<bool> ValidateUserAsync()
    {
        IsProcessing = true;

        user.Email = userModel.Email;
        user.Password = userModel.Password;

        user = await userService.LoginAsync(user);

        if (user.IsAuthenticatedByServer)
        {
            if (user.Email != null)
            {
                await Task.FromResult(PageMetaModel.Instance.Title = $"Velkommen, {user.FirstName} {user.LastName}");
                await ((CustomAuthenticationStateProvider)authenticationStateProvider).MarkUserAuthenticated(user);
                navigationManager.NavigateTo("/admin", true);
            }
            else
            {
                LoginMessage = "Forkert email eller adgangskode.";
            }
        }
        else
        {
            LoginMessage = "Forkert email eller adgangskode.";
        }

        return await Task.FromResult(IsProcessing = false);
    }
}